# プロジェクト進捗状況 - ImageTool

## 📋 プロジェクト概要

画像処理アプリケーション：フォルダ構造から複数画像を1枚の合成画像に変換し、複数プロファイルで一括処理

### 目的
- フォルダ内の複数画像を自動検出・クロップして1枚に合成
- 複数出力プロファイル（pc / mobile / sns）で同時処理（有効化された形式のみ生成）
- フォルダ構造: `images/item1/photo1.jpg` → 出力例: `item1_pc.jpg`

## ✅ 完了した機能

### 1. バッチ処理システム（完成）
- **PC プロファイルで JPG/PNG/PSD の3形式を自動生成**（グループごとに3ファイル出力）
- フォルダ構造の自動解析とグループ化
- YOLO v8による高精度物体検出とクロップ処理
- レイアウトパターン対応（vertical/horizontal/square）
- **ImageOps.fit()相当の精密な画像配置**（Python版と同等品質）
- Mobile / SNS プロファイルは LayoutSettings から形式を有効化すると追加出力

### 2. 自動保存機能（完成）
- File System Access APIを使用したフォルダ直接保存
- **「出力ルート」を一度設定すると、以降は `<出力ルート>/<プロジェクト>/_output/` に自動保存**
- フォルダ選択の永続化（outputRootManager と localStorage で復元）

### 3. 画像検出・処理の高度化（新規完成）
- **白背景商品写真の自動検出**とセンタークロップ処理
- 面積制限付き最大面積選択ロジック（自然写真用）
- 検出結果の詳細ログ出力とデバッグ情報
- 画像タイプ別の最適化された処理フロー

### 4. レイアウト処理の完全実装（新規完成）
- **丸め誤差ゼロの精密画像配置**
- gutter設定による画像間隔の完全制御（現在は隙間なし設定）
- 非同期状態更新タイミング問題の完全解決
- レイアウト設定の即座反映システム

### 5. プロファイル設定 UI / UX 改善
- LayoutSettings でプロファイルサイズ・出力形式・レイアウトパターンを GUI で編集
- OutputPanel と Dropzone からの自動保存ステータス確認
- 使い方アコーディオン・保存先バナーなどのガイダンス強化

### 6. 技術的修正
- OpenCV.js初期化タイミングの問題解決
- React属性警告の修正（webkitdirectory）
- 重複keyエラーの解決
- プロファイル読み込みタイミングの同期問題解決

## 🔄 現在の動作フロー

### バッチ処理（推奨）
1. 初回のみフォルダをドラッグ&ドロップ → 出力ルート設定ダイアログで保存先を指定（例: `~/ImageTool-Output`）
2. 2回目以降はフォルダをドロップすると、自動で `<出力ルート>/<フォルダ名>/_output/` を作成
3. PC プロファイル（JPG/PNG/PSD）がグループごとに自動保存される（Mobile/SNSは有効化時のみ書き出し）
4. 12枚を超える場合は事前警告ダイアログを表示

### 単一画像プレビュー
1. 画像1枚をドロップすると CanvasEditor で bbox を調整
2. 調整内容はブラウザに保存され、次回フォルダを再ドロップした際の再検出に活用
3. 単一画像モードではファイル出力は行わない（プレビューと学習ログのみ）

## ❌ 未解決の課題

### 1. 手動調整の反映（優先度：中）
- **症状**: CanvasEditor で bbox を保存しても自動では再合成されない
- **現状**: 調整値は localStorage に保持されるが、ユーザーが同じフォルダを再ドロップして再検出する必要がある
- **改善案**: 調整済みパラメータを用いた再合成フローを自動化するバッチ再実行ボタンの追加

### 2. 大量ファイル処理時の安定性（優先度：中）
- メモリ使用量が増えるケースでは警告ダイアログで続行可否を確認している
- `composeMany` の処理負荷軽減（ストリーミング書き出し等）は今後の検討事項

### 3. 自動保存ハンドルの復元（優先度：低）
- 出力ルートは永続化されるが、ブラウザ権限失効時には再設定が必要
- セッション復元のリマインド UI を整備したい

## 🎯 今後の作業予定

### 基盤・環境系
- **GitHub Actionsエラー修正**
- **公開環境での調整とテスト**
- テスト駆動開発のための環境整備
- コードの整理整頓とリファクタリング

### UI/UX改善系
- **一覧画像表示の調整**（レイアウト済み一覧→個別画像→選択領域）
- CanvasEditor の調整内容をその場で再合成できる導線検討
- Viteデフォルト表示の削除

### 機能拡張系
- **選択領域調整機能**と自動保存時のパラメータ出力
- **Photoshopファイル出力**（スマートオブジェクト対応理想）
- **自動出力の改善**（保存場所の簡素化、フォルダ指定の廃止検討）

### 残存課題
1. **手動調整の自動再合成フロー設計**
   - 調整結果をバッチジョブに反映する仕組みを検討中

## 📁 主要ファイル構成

```
src/
  components/
    Dropzone.tsx        # フォルダ/ファイル受付、バッチ処理制御
    OutputPanel.tsx     # プロファイル選択と自動保存処理
    CanvasEditor.tsx    # 単一画像の編集（バウンディングボックス調整）
  worker/
    core.ts            # メインワーカー、メッセージルーティング
    opencv.ts          # 画像クロップ・リサイズ処理
    yolo.ts            # 物体検出
  context/
    ProfilesContext.tsx # プロファイル設定の管理
public/
  output_profiles.json  # 出力プロファイル定義
```

## 🔧 開発環境情報

- **フレームワーク**: React + TypeScript + Vite
- **主要ライブラリ**: OpenCV.js, ONNX Runtime, react-dropzone
- **ビルドツール**: pnpm
- **開発コマンド**: `pnpm dev`

## 📊 テスト状況

### ✅ 動作確認済み（完全動作）
- **フォルダ一括処理**（グループごとの PC プロファイル 3形式出力）
- **白背景商品写真の自動検出とクロップ**
- **精密なレイアウト処理**（隙間なし、位置ずれなし）
- **自動保存機能**（File System Access API）
- プロファイル永続化

### 🔧 要確認・改善余地
- 手動調整後の再合成フロー自動化
- 大量ファイル処理時の安定性
- 異なるブラウザでの互換性
- 公開環境での動作確認

## 🏆 主要成果

### 2025-01-10セッション
- **レイアウト処理の完全実装**: 丸め誤差による白線問題を根本解決
- **白背景商品写真対応**: 自動検出による最適クロップ機能
- **非同期処理の安定化**: プロファイル読み込みタイミング問題解決
- **品質向上**: Python版と同等の画像処理品質を実現

## 📝 ドキュメント整備必要項目

1. **技術仕様書**: 画像検出ロジックとレイアウト処理の詳細
2. **ユーザーマニュアル**: フォルダ構造と出力ファイルの命名規則
3. **開発者ガイド**: 新規プロファイル追加とレイアウトパターン設定

---

### 2025-10-07セッション
- 出力ルート管理とプロファイル設定 UI の更新
- 単一画像モードをプレビュー専用に整理し、バッチ処理を主導線として最適化
- Mobile/SNS プロファイルの形式設定を LayoutSettings で管理

**最終更新**: 2025-10-07  
**ステータス**: 🎉 **バッチ処理システム完全動作** 🎉  
**次回優先度**: GitHub Actions修正、公開環境調整
