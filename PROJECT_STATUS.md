# プロジェクト進捗状況 - ImageTool

## 📋 プロジェクト概要

画像処理アプリケーション：フォルダ構造から複数画像を1枚の合成画像に変換し、複数プロファイルで一括処理

### 目的
- フォルダ内の複数画像を自動検出・クロップして1枚に合成
- 複数出力プロファイル（default, web, print, psd）で同時処理
- フォルダ構造: `images/item1/photo1.jpg` → 出力: `item1_web.jpg`

## ✅ 完了した機能

### 1. バッチ処理システム
- **4プロファイル×4グループ=16ファイル**の一括生成が動作
- フォルダ構造の自動解析とグループ化
- YOLO v8による物体検出とクロップ処理
- レイアウトパターン対応（vertical/horizontal/square）

### 2. 自動保存機能
- File System Access APIを使用したフォルダ直接保存
- **1回のフォルダドロップで自動保存完了**（確認ダイアログ経由）
- フォルダ選択の永続化（localStorage）
- ZIP一括ダウンロード機能

### 3. 技術的修正
- OpenCV.js初期化タイミングの問題解決
- React属性警告の修正（webkitdirectory）
- 重複keyエラーの解決
- プロファイル読み込みタイミングの同期問題解決

### 4. UI/UX改善
- 包括的な使い方説明の追加
- バッチモードと単一画像モードの切り替え
- プロファイル設定エディタの統合
- エラーログとデバッグ情報の充実

## 🔄 現在の動作フロー

### バッチ処理（推奨）
1. フォルダをドラッグ&ドロップ
2. 確認ダイアログ: 「前回使用したフォルダ『imagetool_test』に自動保存しますか？」
3. 「OK」→フォルダ選択→16ファイル自動保存完了
4. または「キャンセル」→ZIP/個別ダウンロード

### 単一画像処理
1. 画像1枚をドロップ
2. 右側でプロファイル選択
3. Runボタンで実行

## ❌ 未解決の課題

### 1. 単一画像モードの問題（優先度：高）
- **症状**: 単一画像でプロファイル選択→Runボタンが動作しない
- **推定原因**: プロファイル変更が反映されていない可能性
- **影響**: 単一画像での異なるサイズ出力ができない

### 2. 自動保存の改善余地（優先度：中）
- ブラウザセッション間でのフォルダハンドル復元が不完全
- 毎回確認ダイアログが表示される（UX改善の余地）

### 3. エラーハンドリング（優先度：低）
- OpenCV.js初期化エラーは解決済みだが、稀に発生する可能性
- 大量ファイル処理時のメモリ管理

## 🎯 次回作業予定

### 即座に対応すべき項目
1. **単一画像モードのRunボタン修正**
   - OutputPanel.tsxのhandleRun関数のデバッグ
   - プロファイル選択状態の確認
   - ワーカーメッセージの送信確認

### 機能拡張候補
1. プロファイル設定のリアルタイムプレビュー
2. 処理進捗の詳細表示
3. ファイル名テンプレートのカスタマイズ
4. エラー時の自動リトライ機能

## 📁 主要ファイル構成

```
src/
  components/
    Dropzone.tsx        # フォルダ/ファイル受付、バッチ処理制御
    OutputPanel.tsx     # プロファイル選択、自動保存、ZIP出力
    CanvasEditor.tsx    # 単一画像の編集（バウンディングボックス調整）
  worker/
    core.ts            # メインワーカー、メッセージルーティング
    opencv.ts          # 画像クロップ・リサイズ処理
    yolo.ts            # 物体検出
  context/
    ProfilesContext.tsx # プロファイル設定の管理
public/
  output_profiles.json  # 出力プロファイル定義
```

## 🔧 開発環境情報

- **フレームワーク**: React + TypeScript + Vite
- **主要ライブラリ**: OpenCV.js, ONNX Runtime, react-dropzone
- **ビルドツール**: pnpm
- **開発コマンド**: `pnpm dev`

## 📊 テスト状況

### ✅ 動作確認済み
- フォルダ一括処理（4グループ×4プロファイル=16ファイル）
- 自動保存機能（File System Access API）
- ZIP一括ダウンロード
- プロファイル永続化

### ❌ 要確認
- 単一画像モードでのプロファイル切り替え
- 大量ファイル処理時の安定性
- 異なるブラウザでの互換性

## 📝 次回セッション時の確認事項

1. 単一画像をドロップ→プロファイル変更→Runボタンの動作確認
2. コンソールログで`[OutputPanel] handleRun`関連のメッセージ確認
3. 必要に応じてhandleRun関数のデバッグログ追加

---

**最終更新**: 2025-01-08  
**ステータス**: バッチ処理機能完成、単一画像処理に不具合あり  
**次回優先度**: 単一画像モードのRunボタン修正